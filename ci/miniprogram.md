# Jenkins实现微信小程序持续部署

## 痛点？

自动化一直是我们前端工程化的一个重要方向，前端工程从构建到部署，以自动化脚本执行替代人工操作，不仅能更好地减少中间流程出现的误操作，还能使得开发从重复性的劳动中解放出来； 

小程序开发受限于平台的开发工具，我们在开发的过程中，编译以及部署（上传代码）小程序代码，都需要通过可视化的开发工具，所以H5开发中使用的持续部署流程，并不适用于小程序开发流程；这就使得我们在开发小程序的过程中，构建和发布代码到测试和线上环境，往往需要通过开发的手动操作，万一出现手工误操作，就会阻断测试流程或者出现生产事故了；设想一下以下场景：

- 场景：一个小程序工程往往涉及到多个分支并行开发，每个分支对应着不同的需求或特性，在版本迭代的过程中，每个分支对应上线时间可能不一样；在一个分支正在测试阶段，另一个分支正在开发阶段的情况下，测试找你去修复测试分支的bug，这个时候，你就需要切换到测试分支去修复问题，重新构建和上传代码，提供测试一个新的二维码，然后再回到新的开发分支继续开发；一旦出现新的bug，你又要重复上述工作；

![小程序手工部署流程](./images/miniprogram_build.png)

在这个过程中，构建和部署代码的重复性劳动，大大降低了开发的效率；解决这个痛点，将能提升效率；

## 解决思路

我们知道，H5持续发布的大致流程可以是由`Jenkins`触发构建脚本，构建脚本运行生成目标代码的`dist`文件夹，再通过脚本将`dist`文件夹上传至部署的服务器目录中（此处简化描述了，实际流程可能会更加复杂）；这里注意到了构建和上传的动作都是由脚本执行的，而一般的脚本会使用bash来实现：

```bash
git clone xxx
git checkout target_branch
npm install
npm run build
tar dist
```

执行完脚本后，由Jenkins通过ssh将文件上传到部署的服务器目录中； 

> 那么问题来了，小程序的持续发布是否可以参照呢？这里需要解决的是小程序的构建和上传是否也能实现相关的脚本；

答案是可以的，微信小程序开发工具在新的版本中，推出了`命令行调用`和`http调用`两种方式，使得构建和上传的流程不在拘泥于开发工具的可视化界面；这也意味着，我们也可以编写bash脚本，在Jenkins中自动化执行这些流程； 

好，现在就一起来实践一下！

## 命令行和http调用



## 脚本的实现

## Jenkins配置

## 测试

## 总结


